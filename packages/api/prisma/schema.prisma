// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["filterJson"]
}

model User {
  id             Int        @id @default(autoincrement())
  email          String     @unique
  firstName      String
  lastName       String
  role           String     @default("user")
  emailVerified Boolean    @default(false)
  acceptedTerms  Boolean    @default(false)
  userBanned     Boolean    @default(false)
  ownsEventImports     Boolean    @default(false)
  ownsConentOnDelete   Boolean    @default(false)
  password       String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
  
  locations      Location[]
  
  tokens         Token[]
  
  pages          Page[]
  
  events      Event[]

  images         Image[]    @relation("images")
  
  tours         Tour[]
  
  files         File[]

  tourStops     TourStop[]

  fullText      String? @default("")

  imports      Import[]

  profileImageId Int?           
  profileImage   Image?  @relation(fields: [profileImageId], references: [id], name: "profileImage", onDelete: Cascade)
}

model Location {
  id            Int    @id @default(autoincrement())
  title         Json     
  slug          Json    
  description   Json   @default("{}")
  address       Json?  @default("{}")
  accessibilityInformation       Json?  @default("{}")
  contactInfo   Json?  @default("{}")
  offers        Json?  @default("{}")
  geoCodingInfo Json?  @default("{}")
  socialMedia   Json?  @default("{}")

  visibleFrom   DateTime?
  visibleFromTime   DateTime?

  visibleUntil  DateTime?
  visibleUntilTime  DateTime?

  status      Int  

  lat         Float?
  lng         Float?

  events      Event[]
  images      Image[]
  terms       Term[]        @relation(name: "locationTerms")
  tourStops   TourStop[]

  fullText      String? @default("")

  ownerId     Int    
  owner       User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  heroImageId    Int?
  heroImage      Image?    @relation(fields: [heroImageId], references: [id], name: "locationHeroImage", onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  eventLocationId  Int? 
  
  agency      String? 

  primaryTypeId    Int?
  primaryType      Term?    @relation(fields: [primaryTypeId], references: [id], name: "locationPrimaryType", onDelete: Cascade)

  @@index([ownerId], name: "indexLocationOwnerId")
}


model Event {
  id            Int    @id @default(autoincrement())
  hash          String @default("")
  title           Json     
  slug           Json    
  description   Json?  @default("{}")
  meta Json?    @default("{}")
  
  isFree        Boolean @default(false)
  isImported        Boolean @default(false)
  locations      Location[]

  ownerId     Int    
  owner       User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  status      Int  
  
  images   Image[]
  dates  EventDate[]
  terms       Term[]

  heroImageId    Int?
  heroImage      Image?    @relation(fields: [heroImageId], references: [id], name: "eventHeroImage", onDelete: Cascade)

  fullText      String? @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  importedEventHash  String? 

  @@index([ownerId], name: "indexEventOwnerId")
}

model EventDate {
  id      Int    @id @default(autoincrement())
  date    DateTime 
  begin   DateTime
  end     DateTime
  eventId    Int?
  event      Event?    @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model EventImportLog {
  id      Int    @id @default(autoincrement())
  log     Json?    @default("[]") 
  errors    Json?    @default("[]") 
  warnings Json?    @default("[]") 
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Token {
  id     Int    @id @default(autoincrement())
  token  String
  type   String @db.VarChar(16)
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires     DateTime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([userId], name: "indexTokenUserId")
}

model Setting {
  id     Int    @id @default(autoincrement())
  key    String @db.VarChar(128) @unique
  value   Json
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
}

model Module {
  id             Int        @id @default(autoincrement())
  key            String     @db.VarChar(12) @unique
  name           Json
  withTaxonomies Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
  taxonomies     Taxonomy[]
}

model Taxonomy {
  id             Int        @id @default(autoincrement())
  name           Json     
  slug           Json     
  multiTerm      Boolean    @default(false)
  hasColor       Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt

  fullText      String? @default("")

  terms          Term[]
  modules        Module[]

}

model Term {
  id             Int        @id @default(autoincrement())
  name           Json     
  slug           Json   

  color          String @default("")
  colorDark      String @default("")
  taxonomyId     Int
  taxonomy       Taxonomy   @relation(fields: [taxonomyId], references: [id], onDelete: Cascade)

  locations      Location[] @relation(name: "locationTerms", onDelete: Cascade)

  primaryTypeLocation Location? @relation(name: "locationPrimaryType")

  events         Event[]

  fullText      String? @default("")

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt

  @@index([taxonomyId], name: "indexTermTaxonomyId")
}


model Tour {
  id             Int        @id @default(autoincrement())
  
  title          Json     
  slug           Json     
  duration       Json
  distance       Json    
  teaser         Json
  description    Json
  path           Json

  heroImageId    Int?
  heroImage      Image?    @relation(fields: [heroImageId], references: [id], name: "tourHeroImage", onDelete: Cascade)

  status         Int  

  fullText       String    @default("")

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt

  ownerId     Int    
  owner       User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  @@index([ownerId], name: "indexTourOwnerId")

  tourStops          TourStop[]  
}

model TourStop {
  id             Int        @id @default(autoincrement())
  
  title          Json     
  number         Int?        @default(1)


  loactionId     Int
  location       Location?    @relation(fields: [loactionId], references: [id], onDelete: Cascade)

  teaser         Json
  description    Json
  
  tourId        Int?
  tour          Tour?    @relation(fields: [tourId], references: [id])

  heroImageId    Int?
  heroImage      Image?    @relation(fields: [heroImageId], references: [id], name: "tourStopHeroImage", onDelete: Cascade)

  fullText       String    @default("")

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
  
  ownerId     Int    
  owner       User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  @@index([ownerId], name: "indexTourStopOwnerId")

}

model Page {
  id             Int        @id @default(autoincrement())
  
  title          Json     
  slug           Json     
  intro          Json
  content        Json

  heroImageId    Int?
  heroImage      Image?    @relation(fields: [heroImageId], references: [id], name: "pageHeroImage", onDelete: Cascade)

  status         Int  

  fullText       String    @default("")

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
  ownerId     Int    
  owner       User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  @@index([ownerId], name: "indexPageOwnerId")
}

// TODO: add a retry mechanism 
model Image {
  id             Int        @id @default(autoincrement())
  
  nanoid         String     @db.VarChar(48) @unique
  meta           Json
  status         Int        @default(0)
  orderNumber    Int        @default(0)
  
  retryCount     Int        @default(0)
  type           String     @db.VarChar(16) @default("image")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
  ownerId        Int           
  owner          User   @relation(fields: [ownerId], references: [id], name: "images", onDelete: Cascade)

  events         Event[]
  locations      Location[]
  translations   ImageTranslation[]

  profileImageUsers   User[]  @relation("profileImage")
  heroImagePages      Page[]  @relation("pageHeroImage")
  heroImageEvents     Event[]  @relation("eventHeroImage")
  heroImageLocations  Location[]  @relation("locationHeroImage")
  heroImageTours      Tour[]  @relation("tourHeroImage")
  heroImageTourStops  TourStop[]  @relation("tourStopHeroImage")

  @@index([ownerId], name: "indexImageOwnerId")
  @@index([ownerId, type], name: "indexImageOwnerIdType")
  @@index([status], name: "indexImageStatus")
}

model ImageTranslation {
  id              Int        @id @default(autoincrement())
  key             String     @db.VarChar(24)
  lang            String     @db.VarChar(4)
  translation     String
  
  imageId    Int     
  image           Image?     @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@unique([imageId, key, lang], name: "uniqueTransKeys")
}

model Import {
  id             Int        @id @default(autoincrement())
  title          String     
  log            Json?      @default("[]")
  errors         Json?      @default("[]")
  mapping        Json?      @default("[]")
  warnings        Json?      @default("[]")
  status         Int        @default(0)

  fileId         Int?
  file           File?    @relation(fields: [fileId], references: [id], name: "importFiles")
  
  ownerId        Int    
  owner          User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
}

model File {
  id             Int        @id @default(autoincrement())
  
  nanoid         String     @db.VarChar(48) @unique
  status         Int        @default(0)
  meta           Json

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @default(now()) @updatedAt
  
  ownerId        Int           
  owner          User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  imports        Import[]  @relation("importFiles")
}